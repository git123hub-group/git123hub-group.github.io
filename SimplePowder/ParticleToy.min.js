var currentType=2,currentProp=0;!function(){function r(){for(var r,e=0;66>e;e++)for(var a=0;82>a;a++)t(a,e,B[r=(82*e+a)*E],B[r+4])}function e(r){var e=r*R,a=0|O[e+2],n=0|O[e+3];P.fillStyle="#FFFFFF",P.fillRect(10*a,10*n,10,10)}function a(){P.clearRect(0,0,820,660);for(var r=0,a=0;D>a;r++)0!==O[r*R]&&(a++,e(r))}function n(r,e,a){var n=(82*e+r)*E;return 0!==B[n]?!1:(B[n]=a,B[n+1]=0,B[n+2]=0,B[n+3]=0,B[n+4]=0,B[n+5]=0,!0)}function t(r,e,a,n){F.globalAlpha=1,F.clearRect(10*r,10*e,10,10),0!==a&&(F.fillStyle=_[a],F.fillRect(10*r,10*e,10,10),6!==a&&4278190080&n&&(F.globalAlpha=(n>>>24)/255,F.fillStyle="#"+(n>>>0).toString(16).slice(-6),F.fillRect(10*r,10*e,10,10)))}function o(r,a,o,c){var l,i=(82*a+r)*E;if(0>=c){if(0!==o){if(!n(r,a,o))return void(8!==B[i]&&11!==B[i]&&(B[i+1]=o))}else B[i]=0;t(r,a,o,0)}else if(6>=c)0!==B[i]&&(B[i+c-1]=o,(1===c||5===c)&&t(r,a,o,B[i+4]));else if(7===c)if(0===o)S[82*a+r]=0,C.clearRect(10*r,10*a,10,10);else if(256>o)S[82*a+r]=o,C.fillStyle=Q[o-1],C.fillRect(10*r,10*a,10,10);else if(!mouseEntered)switch(o){case 256:1===S[82*a+r]?f(r,a,1,2):2===S[82*a+r]&&f(r,a,2,1);break;case 257:l=d(r,a,4*Math.random(),1),T[i=82*a+r]=l,e(l)}}function f(r,e,a,n){console.debug(n);var t,o,f,c,l=[r,e],i=2;do{for(f=82*(e=l[--i]),t=o=r=l[--i];t>=0&&S[f+t-1]===a;)t--;for(;82>o&&S[f+o+1]===a;)o++;for(C.fillStyle=Q[n-1],C.fillRect(10*t,10*e,10*(o-t+1),10),r=t;o>=r;r++)S[f+r]=n;if(e>=1)for(c=e-1,f-=82,r=t;o>=r;r++)S[f+r]===a&&(l[i++]=r,l[i++]=c);if(81>e)for(c=e+1,f+=164,r=t;o>=r;r++)S[f+r]===a&&(l[i++]=r,l[i++]=c)}while(i)}function c(r,e){return r>=0&&82>r&&e>=0&&66>e}function l(r,e){if(1!==S[82*e+r]){var a=B[(82*e+r)*E];null!=H[a]&&H[a](r,e);var n,t,o,f,l=W[a],i=Math.random()<.5?1:-1,u=e+1,d=!1,v=!1;switch(l){case 1:for(n=0;1>=n;n=-2*n+1){if(t=c(o=r+n*i,u),f=B[(82*u+o)*E],!t||5===f){d=!0;break}if(K[f]<K[a]){v=!0,f=a,d=!0;break}}break;case 2:for(n=0;1>=n;n=-2*n+1){if(t=c(o=r+n*i,u),f=B[(82*u+o)*E],!t||5===f){d=!0;break}if(K[f]<K[a]){v=!0,f=a,d=!0;break}1===n&&(u=e)}break;case 3:if(t=c(o=r+Math.round(2.2*Math.random()-1.1),u=e+Math.round(2.2*Math.random()-1.1)),f=B[(82*u+o)*E],!t||5===f){d=!0;break}if(0===f){v=!0,f=a,d=!0;break}break;case 4:for(n=1;n>=0;){if(t=c(o=r+(i=Math.round(2*Math.random()-1)),u=e-n--),f=B[(82*u+o)*E],!t||5===f){d=!0;break}if(K[f]<K[a]){v=!0,f=a,d=!0;break}}}if(d)if(v)for(var s=0;E>s;s++)n=B[i=(82*u+o)*E+s],B[i]=B[a=(82*e+r)*E+s],B[a]=n;else B[(82*e+r)*E]=0}}function i(r){var e=r*R,a=3&O[e+1],n=0|O[e+2],t=0|O[e+3],o=n,f=t,l=j[a],i=z[a];return n+=l,t+=i,c(n,t)?(0===B[(82*t+n)*E]&&(n+=l,t+=i),c(n,t)?(v(r,o,f),T[tmp=82*t+n]=r,O[e+2]=n,void(O[e+3]=t)):(u(r),void v(r,o,f))):(u(r),void v(r,o,f))}function u(r){O[r*R]=0,O[r*R+1]=L,L=r,D--}function d(r,e,a,n){var t,o=L;return L=O[(t=o*R)+1],O[t++]=n,O[t++]=a,O[t++]=r,O[t]=e,D++,o}function v(r,e,a){var n;T[n=82*a+e]===r&&(T[n]=-1)}function s(){for(var r,e,a=0;5412>a;a++)T[a]=-1;for(var a=0,n=0;D>n;a++)if(0!==O[a*R]){n++;var t=a*R;r=0|O[t+2],e=0|O[t+3],T[82*e+r]=a}}function m(){for(var e=0,n=0;D>n;e++)0!==O[e*R]&&(n++,i(e));for(var e=0;4500>e;e++)l(82*Math.random()|0,66*Math.random()|0);D>0&&s(),a(),r()}function b(r){for(var e=$[r++],a=$[r],n=0;15>n;n++)a>e?(Z[n]=e,document.getElementById("Menu_"+n).value=J[e++]):(Z[n]=-1,document.getElementById("Menu_"+n).value="")}function h(r){switch(Z[r]){case 0:A=!A;break;case 1:A=!1,m();break;case 2:y(0);break;case 3:y(1);break;case 4:y(2);break;case 5:y(3);break;case 6:y(4);break;case 7:currentProp=7,currentType=nr[1],ar=1;for(var e=4;15>e;e++)tr[e]=-1,document.getElementById("Part_"+e).value="";for(var e=0;4>e;e++)tr[e]=er[e],document.getElementById("Part_"+e).value=rr[e];break;case 8:b(1);break;case 9:b(0);break;case 10:k(1);break;case 11:k(2);break;case 12:k(3);break;case 13:k(4);break;case 14:k(5);break;case 15:k(6)}}function k(r){var e=prompt("Change particle property");null!=e&&(currentProp=r,currentType="#"===e.charAt(0)||"0x"===e.substr(0,2)?parseInt(e.slice(-8),16):parseInt(e))}function M(r){r>=0&&(nr[ar]=currentType=tr[r])}function y(r){0!==currentProp&&(currentProp=0,ar=0,currentType=nr[0]);for(var e,a=0,n=0;15>n;n++)tr[n]=-1,document.getElementById("Part_"+n).value="";for(var n=0;q>n;n++)N[n]===r&&(tr[a]=n,a++);for(var n=0;15>n&&a>n;n++)e=tr[n],document.getElementById("Part_"+n).value=X[e]}for(var A,w=document.getElementById("InvisLayer"),I=document.getElementById("PartLayer"),p=document.getElementById("PhotonsLayer"),C=w.getContext("2d"),F=I.getContext("2d"),P=p.getContext("2d"),E=6,R=4,g=0,S=new Uint8Array(5412),B=new Int32Array(5412*E),T=new Int16Array(5412),O=new Int16Array(6e3*R),D=0,L=0,Y=0;82>Y;Y++)B[Y*E]=1,B[(Y+5330)*E]=1;for(var Y=0;66>Y;Y++)B[82*Y*E]=1,B[(82*Y+81)*E]=1;for(var Y=0;5999>Y;)O[4*Y+1]=++Y;O[23997]=-1;for(var Y=0;5412>Y;Y++)T[Y]=-1;var X=["X","BLCK","DUST","WATR","CLNE","VOID","VIRS","CURE","ACID","OIL","MERC","FIRE","WOOD","WTRV"],_=["#000000","#AAAAAA","#FFE0A0","#2030D0","#CCCC00","#790B0B","#FE11F6","#F5F5DC","#EE66FF","#483810","#746A6A","#FF0000","#bf9c1d","#A0A0FF"],V=[0,0,1,1,0,0,1,1,1,1,1,1,0,1],x=[0,0,1,1,1,1,0,0,1,1,1,1,1,1],G=[0,0,1,0,0,0,1,1,0,.2,1,0,1,1],U=[0,0,1,0,0,0,0,0,0,1,0,0,1,0],W=[0,0,1,2,0,0,2,2,2,2,2,4,0,4],N=[4,4,1,2,4,4,2,2,2,2,2,3,0,3],K=[0,1e3,800,400,1e3,0,420,420,390,300,900,1,1e3,1],q=14,H=[null,null,null,null,function(r,e){var a,t=(82*e+r)*E+1;if(0!==(a=B[t])){var o=r+(3*Math.random()|0)-1,f=e+(3*Math.random()|0)-1;c(o,f)&&n(o,f,a)}else r:for(var l=-1;2>l;l++)for(var i=-1;2>i;i++)if(c(o=r+l,f=e+i)&&(a=B[(82*f+o)*E],V[a])){B[t]=a;break r}},null,function(r,e){var a,n,t,o,f=(82*e+r)*E;if(B[f+5]>0){for(var l=0;4>l;l++)a=r+(3*Math.random()|0)-1,n=e+(3*Math.random()|0)-1,c(a,n)&&(t=(82*n+a)*E,6===B[t]&&B[t+5]<=0&&(B[t+5]=B[f+5]+2));return void(--B[f+5]||(B[f]=B[f+3],B[f+3]=0))}a=r+(3*Math.random()|0)-1,n=e+(3*Math.random()|0)-1,c(a,n)&&(t=(82*n+a)*E,o=B[t],7===o?(B[t]=0,B[f+5]=30):x[o]&&(B[t]=6,B[t+3]=o,B[t+5]=0),console.log(B[f+5]))},null,function(r,e){var a,n,t=30,o=(82*e+r)*E+1;if(.6<Math.random()){if(newX=r+(3*Math.random()|0)-1,newY=e+(3*Math.random()|0)-1,!c(newX,newY))return;if(a=(82*newY+newX)*E,n=B[a],3===n)return n=B[o]+t>>1,B[a]=8,void(B[a+1]=B[o]=n);if(8===n)return void(B[o]>=t?B[o-1]=0:(n=B[a+1]-B[o]>>1,B[a+1]-=n,B[o]+=n));Math.random()<G[n]&&(B[a]=0,B[o]+=2)}},null,null,function(r,e){var a,n=(82*e+r)*E+1;B[n]>18&&(B[n-1]=0);for(var t=0;2>t;t++)if(newX=r+(3*Math.random()|0)-1,newY=e+(3*Math.random()|0)-1,c(newX,newY)){var o=(82*newY+newX)*E;a=B[o],3===a&&(newY<e?B[o]=13:B[n-1]=0),U[a]&&(B[o]=11,B[o+1]=0)}B[n]++},null,null],Q=["#00CCCC","#0F0064"],j=[1,0,-1,0],z=[0,-1,0,1],J=["PAUS","FRAM","SOLD","PWDR","LIQD","GAS","SPEC","INVS","PROP","BACK","TYPE","CTYP","ARG3","ARG4","DECO","TMP"],Z=[],$=[0,9,16];b(0);var rr=["X","INVS","TOGL","PHOT"],er=[0,1,256,257],ar=0,nr=[2,1];r();var tr=[];y(1),!function or(){A&&g>5&&(m(),g=0),g++,requestAnimationFrame(or)}(),window.selectOpt=h,window.selectPart=M,window.mouse_partOP=o}();