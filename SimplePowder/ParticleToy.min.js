function renderParts(){for(var a,r=0;66>r;r++)for(var e=0;82>e;e++)renderPart(e,r,map_P[a=(82*r+e)*params_P],map_P[a+4])}function renderPhoton(a){var r=a*params_F,e=0|parts_F[r+2],t=0|parts_F[r+3];ctx_F.fillStyle="#FFFFFF",ctx_F.fillRect(10*e,10*t,10,10)}function renderPhotons(){ctx_F.clearRect(0,0,820,660);for(var a=0,r=0;photons_count>r;a++)0!==parts_F[a*params_F]&&(r++,renderPhoton(a))}function create_part(a,r,e){var t=(82*r+a)*params_P;return 0!==map_P[t]?!1:(map_P[t]=e,map_P[t+1]=0,map_P[t+2]=0,map_P[t+3]=0,map_P[t+4]=0,map_P[t+5]=0,!0)}function renderPart(a,r,e,t){ctx_P.globalAlpha=1,ctx_P.clearRect(10*a,10*r,10,10),0!==e&&(ctx_P.fillStyle=default_color[e],ctx_P.fillRect(10*a,10*r,10,10),6!==e&&4278190080&t&&(ctx_P.globalAlpha=(t>>>24)/255,ctx_P.fillStyle="#"+(t>>>0).toString(16).slice(-6),ctx_P.fillRect(10*a,10*r,10,10)))}function mouse_partOP(a,r,e,t){var n,_=(82*r+a)*params_P;if(0>=t){if(0!==e){if(!create_part(a,r,e))return void(8!==map_P[_]&&11!==map_P[_]&&(map_P[_+1]=e))}else map_P[_]=0;renderPart(a,r,e,0)}else if(6>=t)0!==map_P[_]&&(map_P[_+t-1]=e,(1===t||5===t)&&renderPart(a,r,e,map_P[_+4]));else if(7===t)if(0===e)map_I[82*r+a]=0,ctx_I.clearRect(10*a,10*r,10,10);else if(256>e)map_I[82*r+a]=e,ctx_I.fillStyle=invisColours[e-1],ctx_I.fillRect(10*a,10*r,10,10);else if(!mouseEntered)switch(e){case 256:1===map_I[82*r+a]?floodInvis(a,r,1,2):2===map_I[82*r+a]&&floodInvis(a,r,2,1);break;case 257:n=alloc_phot(a,r,4*Math.random(),1),map_F[_=82*r+a]=n,renderPhoton(n)}}function floodInvis(a,r,e,t){console.debug(t);var n,_,p,o,m=[a,r],s=2;do{for(p=82*(r=m[--s]),n=_=a=m[--s];n>=0&&map_I[p+n-1]===e;)n--;for(;82>_&&map_I[p+_+1]===e;)_++;for(ctx_I.fillStyle=invisColours[t-1],ctx_I.fillRect(10*n,10*r,10*(_-n+1),10),a=n;_>=a;a++)map_I[p+a]=t;if(r>=1)for(o=r-1,p-=82,a=n;_>=a;a++)map_I[p+a]===e&&(m[s++]=a,m[s++]=o);if(81>r)for(o=r+1,p+=164,a=n;_>=a;a++)map_I[p+a]===e&&(m[s++]=a,m[s++]=o)}while(s)}function checkBounds(a,r){return a>=0&&82>a&&r>=0&&66>r}function try_move(a,r){if(1!==map_I[82*r+a]){var e=map_P[(82*r+a)*params_P];null!=Update_P[e]&&Update_P[e](a,r);var t,n,_,p,o=ST_List[e],m=Math.random()<.5?1:-1,s=r+1,c=!1,i=!1;switch(o){case 1:for(t=0;1>=t;t=-2*t+1){if(n=checkBounds(_=a+t*m,s),p=map_P[(82*s+_)*params_P],!n||5===p){c=!0;break}if(ST_Weight[p]<ST_Weight[e]){i=!0,p=e,c=!0;break}}break;case 2:for(t=0;1>=t;t=-2*t+1){if(n=checkBounds(_=a+t*m,s),p=map_P[(82*s+_)*params_P],!n||5===p){c=!0;break}if(ST_Weight[p]<ST_Weight[e]){i=!0,p=e,c=!0;break}1===t&&(s=r)}break;case 3:if(n=checkBounds(_=a+Math.round(2*Math.random()-1),s=r+Math.round(2*Math.random()-1)),p=map_P[(82*s+_)*params_P],!n||5===p){c=!0;break}if(0===p){i=!0,p=e,c=!0;break}break;case 4:if(n=checkBounds(_=a+Math.round(2*Math.random()-1),s=r-1),p=map_P[(82*s+_)*params_P],!n||5===p){c=!0;break}if(ST_Weight[p]<ST_Weight[e]){i=!0,p=e,c=!0;break}}if(c)if(i)for(var P=0;params_P>P;P++)t=map_P[m=(82*s+_)*params_P+P],map_P[m]=map_P[e=(82*r+a)*params_P+P],map_P[e]=t;else map_P[(82*r+a)*params_P]=0}}function try_move_phot(a){var r=a*params_F,e=3&parts_F[r+1],t=0|parts_F[r+2],n=0|parts_F[r+3],_=t,p=n,o=rx_table[e],m=ry_table[e];return t+=o,n+=m,checkBounds(t,n)?(0===map_P[(82*n+t)*params_P]&&(t+=o,n+=m),checkBounds(t,n)?(kill_phot_pos(a,_,p),map_F[tmp=82*n+t]=a,parts_F[r+2]=t,void(parts_F[r+3]=n)):(free_phot(a),void kill_phot_pos(a,_,p))):(free_phot(a),void kill_phot_pos(a,_,p))}function free_phot(a){parts_F[a*params_F]=0,parts_F[a*params_F+1]=pfree,pfree=a,photons_count--}function alloc_phot(a,r,e,t){var n,_=pfree;return pfree=parts_F[(n=_*params_F)+1],parts_F[n++]=t,parts_F[n++]=e,parts_F[n++]=a,parts_F[n]=r,photons_count++,_}function kill_phot_pos(a,r,e){var t;map_F[t=82*e+r]===a&&(map_F[t]=-1)}function recalc_phot(){for(var a,r,e=0;5412>e;e++)map_F[e]=-1;for(var e=0,t=0;photons_count>t;e++)if(0!==parts_F[e*params_F]){t++;var n=e*params_F;a=0|parts_F[n+2],r=0|parts_F[n+3],map_F[82*r+a]=e}}function frame_render(){for(var a=0,r=0;photons_count>r;a++)0!==parts_F[a*params_F]&&(r++,try_move_phot(a));for(var a=0;4500>a;a++)try_move(82*Math.random()|0,66*Math.random()|0);photons_count>0&&recalc_phot(),renderPhotons(),renderParts()}function getFnMenu(a){for(var r=fnList2[a++],e=fnList2[a],t=0;15>t;t++)e>r?(fnListID[t]=r,document.getElementById("Menu_"+t).value=fnList[r++]):(fnListID[t]=-1,document.getElementById("Menu_"+t).value="")}function selectOpt(a){switch(fnListID[a]){case 0:runningFlag=!runningFlag;break;case 1:runningFlag=!1,frame_render();break;case 2:showPartMenu(0);break;case 3:showPartMenu(1);break;case 4:showPartMenu(2);break;case 5:showPartMenu(3);break;case 6:showPartMenu(4);break;case 7:currentProp=7,currentType=prevElem[1],ElemType=1;for(var r=4;15>r;r++)menu2partID[r]=-1,document.getElementById("Part_"+r).value="";for(var r=0;4>r;r++)menu2partID[r]=invisMenuID[r],document.getElementById("Part_"+r).value=invisMenu[r];break;case 8:getFnMenu(1);break;case 9:getFnMenu(0);break;case 10:propertyTool(1);break;case 11:propertyTool(2);break;case 12:propertyTool(3);break;case 13:propertyTool(4);break;case 14:propertyTool(5);break;case 15:propertyTool(6)}}function propertyTool(a){var r=prompt("Change particle property");null!=r&&(currentProp=a,currentType="#"===r.charAt(0)||"0x"===r.substr(0,2)?parseInt(r.slice(-8),16):parseInt(r))}function selectPart(a){a>=0&&(prevElem[ElemType]=currentType=menu2partID[a])}function showPartMenu(a){7!==currentProp&&(currentProp=0,ElemType=0,currentType=prevElem[0]);for(var r,e=0,t=0;15>t;t++)menu2partID[t]=-1,document.getElementById("Part_"+t).value="";for(var t=0;type_count>t;t++)ST_Menu_List[t]===a&&(menu2partID[e]=t,e++);for(var t=0;15>t&&e>t;t++)r=menu2partID[t],document.getElementById("Part_"+t).value=partName[r]}for(var canvas_I=document.getElementById("InvisLayer"),canvas_P=document.getElementById("PartLayer"),canvas_F=document.getElementById("PhotonsLayer"),ctx_I=canvas_I.getContext("2d"),ctx_P=canvas_P.getContext("2d"),ctx_F=canvas_F.getContext("2d"),currentType=2,currentProp=0,params_P=6,params_F=4,runningFlag,__frames=0,map_I=new Uint8Array(5412),map_P=new Int32Array(5412*params_P),map_F=new Int16Array(5412),parts_F=new Int16Array(6e3*params_F),photons_count=0,pfree=0,i=0;82>i;i++)map_P[i*params_P]=1,map_P[(i+5330)*params_P]=1;for(var i=0;66>i;i++)map_P[82*i*params_P]=1,map_P[(82*i+81)*params_P]=1;for(var i=0;5999>i;)parts_F[4*i+1]=++i;parts_F[23997]=-1;for(var i=0;5412>i;i++)map_F[i]=-1;var partName=["X","BLCK","DUST","WATR","CLNE","VOID","VIRS","CURE","ACID","OIL","MERC","FIRE"],default_color=["#000000","#AAAAAA","#FFE0A0","#2030D0","#CCCC00","#790B0B","#FE11F6","#F5F5DC","#EE66FF","#483810","#746A6A","#FF0000"],can_clone=[0,0,1,1,0,0,1,1,1,1,1,1],can_infe=[0,0,1,1,1,1,0,0,1,1,1,1],acidAffect=[0,0,1,0,0,0,1,1,0,.2,1,0],flammable=[0,0,1,0,0,0,0,0,0,1,0,0],ST_List=[0,0,1,2,0,0,2,2,2,2,2,4],ST_Menu_List=[4,4,1,2,4,4,2,2,2,2,2,3],ST_Weight=[0,1e3,800,400,1e3,0,420,420,390,300,900,1],type_count=13,Update_P=[null,null,null,null,function(a,r){var e,t=(82*r+a)*params_P+1;if(0!==(e=map_P[t])){var n=a+(3*Math.random()|0)-1,_=r+(3*Math.random()|0)-1;checkBounds(n,_)&&create_part(n,_,e)}else a:for(var p=-1;2>p;p++)for(var o=-1;2>o;o++)if(checkBounds(n=a+p,_=r+o)&&(e=map_P[(82*_+n)*params_P],can_clone[e])){map_P[t]=e;break a}},null,function(a,r){var e,t,n,_,p=(82*r+a)*params_P;if(map_P[p+5]>0){for(var o=0;4>o;o++)e=a+(3*Math.random()|0)-1,t=r+(3*Math.random()|0)-1,checkBounds(e,t)&&(n=(82*t+e)*params_P,6===map_P[n]&&map_P[n+5]<=0&&(map_P[n+5]=map_P[p+5]+2));return void(--map_P[p+5]||(map_P[p]=map_P[p+3],map_P[p+3]=0))}e=a+(3*Math.random()|0)-1,t=r+(3*Math.random()|0)-1,checkBounds(e,t)&&(n=(82*t+e)*params_P,_=map_P[n],7===_?(map_P[n]=0,map_P[p+5]=30):can_infe[_]&&(map_P[n]=6,map_P[n+3]=_,map_P[n+5]=0),console.log(map_P[p+5]))},null,function(a,r){var e,t,n=30,_=(82*r+a)*params_P+1;if(.6<Math.random()){if(newX=a+(3*Math.random()|0)-1,newY=r+(3*Math.random()|0)-1,!checkBounds(newX,newY))return;if(e=(82*newY+newX)*params_P,t=map_P[e],3===t)return t=map_P[_]+n>>1,map_P[e]=8,void(map_P[e+1]=map_P[_]=t);if(8===t)return void(map_P[_]>=n?map_P[_-1]=0:(t=map_P[e+1]-map_P[_]>>1,map_P[e+1]-=t,map_P[_]+=t));Math.random()<acidAffect[t]&&(map_P[e]=0,map_P[_]+=2)}},null,null,function(a,r){var e=(82*r+a)*params_P+1;map_P[e]>18&&(map_P[e-1]=0);for(var t=0;2>t;t++)if(newX=a+(3*Math.random()|0)-1,newY=r+(3*Math.random()|0)-1,checkBounds(newX,newY)){var n=(82*newY+newX)*params_P;flammable[map_P[n]]&&(map_P[n]=11,map_P[n+1]=0)}map_P[e]++}],invisColours=["#00CCCC","#0F0064"],rx_table=[1,0,-1,0],ry_table=[0,-1,0,1],fnList=["PAUS","FRAM","SOLD","PWDR","LIQD","GAS","SPEC","INVS","PROP","BACK","TYPE","CTYP","ARG3","ARG4","DECO","TMP"],fnListID=[],fnList2=[0,9,16];getFnMenu(0);var invisMenu=["X","INVS","TOGL","PHOT"],invisMenuID=[0,1,256,257],ElemType=0,prevElem=[2,1];renderParts();var menu2partID=[];showPartMenu(1),!function a(){runningFlag&&__frames>5&&(frame_render(),__frames=0),__frames++,requestAnimationFrame(a)}();