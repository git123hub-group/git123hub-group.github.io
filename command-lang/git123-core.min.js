function parseFmt1(a){var b=new Date,c=b.getFullYear()+"/"+zpadd2(b.getMonth())+"/"+zpadd2(b.getDate()),d=zpadd2(b.getHours())+":"+zpadd2(b.getMinutes())+":"+zpadd2(b.getSeconds())+"."+zpadd3(b.getMilliseconds());return a.replace(/\$((?:\\[\s\S]|[^\\\$])*)\$/g,function(a,e){if(""===e)return"$";var f,g,h,j,i=e.match(/(.*?)(?::|$)/)[1],k=e.slice(i.length+1);if("~"!==i.charAt(0))j=variableList["var_"+i];else switch(i){case"~date":j=c;break;case"~expr":return execNumExpr(k.replace(/\s/g,""));case"~time":j=d;break;case"~rtime":j=b.getTime()-firstTime.getTime()+"";break;case"~random":j=""+(4294967296*Math.random()|0);break;case"~randr":var l=k.split(",");return+l[0]+Math.random()*(l[1]-l[0]+1)|0;case"~line":return"\n";case"~space":return" ";case"~tab":return"	";case"~tline":return+significantLines+ +k}if(f=k.match(/^((?:\\[\s\S]|[^\\\=])*)=((?:\\[\s\S]|[^\\\=])*)$/))return g=f[1].replace(/\\([\s\S])/g,"$1"),h=f[2].replace(/\\([\s\S])/g,"$1"),j.split(g).join(h);if(f=k.match(/^(\w+):([\s\S]*)$/))switch(g=f[1],h=f[2].replace(/\\([\s\S])/g,"$1"),!0){case/\bfirst\b/.test(g):return j.indexOf(h);case/\blast\b/.test(g):return j.lastIndexOf(h)}if(f=k.match(/^(-?\d+)$/))return j.slice(f[1]);if(f=k.match(/^(-?\d+),(-?\d+)$/))return j.slice(f[1],f[2]);switch(k){case"rev":case"reverse":return esrever.reverse(j);case"len":case"length":return j.length;case"lower":return j.toLowerCase();case"upper":return j.toUpperCase();case"bin":return(+j>>>0).toString(2);case"chr":return String.fromCharCode(j);case"oct":return(+j>>>0).toString(8);case"hex":return(+j>>>0).toString(16);case"fbin":return parseInt(j,2);case"ord":return j.charCodeAt(0);case"foct":return parseInt(j,8);case"fhex":return parseInt(j,16);case"var":return variableList["var_"+j];case"fmt":return parseFmt1(j)}return j})}function cmpF(a,b,c){switch(a=a.toLowerCase()){case"==":case"equ":return b===c;case"!=":case"neq":return b!==c;case"<":case"lss":return c>b;case"<=":case"leq":return c>=b;case">":case"gtr":return b>c;case">=":case"geq":return b>=c}}function HTMLEscape(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function KernelStep(a){if(a=String(a).replace(/[\s\t\xa0\u3000]*/,""),":"===a.charAt(0)||"#"===a.charAt(0)||""===a)return void++lineNum;var b=a.match(/[A-Za-z0-9\-\_$]+(:[A-Za-z0-9\-\_$]*)?/)[0],c=b.split(":");c.length<2&&(c[1]="");var e,d=a.slice(b.length).replace(/\s/,"");switch(c[0]){case"write":switch(c[1]){case"cssf":d=parseFmt1("var_"+d),hout+='<span style="'+HTMLEscape(d)+'">',KernelStep(compiled[lineNum+1]),hout+="</span>";break;case"css":hout+='<span style="'+HTMLEscape(d)+'">',KernelStep(compiled[lineNum+1]),hout+="</span>";break;case"multi":for(var f=parseInt(d);f&&!(lineNum+1>=significantLines);)hout+=HTMLEscape(compiled[++lineNum]),--f;break;case"var":hout+=HTMLEscape(variableList["var_"+d]);break;case"format":hout+=HTMLEscape(parseFmt1(d));break;case"readln":hout+=HTMLEscape(compiled[d]);break;default:hout+=HTMLEscape(d)}++lineNum;break;case"writeln":switch(c[1]){case"format":hout+=HTMLEscape(parseFmt1(d))+"\n";break;case"readln":hout+=HTMLEscape(compiled[d])+"\n";break;case"multi":for(var f=parseInt(d);f&&!(lineNum+1>=significantLines);)hout+=HTMLEscape(compiled[++lineNum])+"\n",--f;break;default:hout+=HTMLEscape(d)+"\n"}++lineNum;break;case"alert":switch(c[1]){case"format":alert(parseFmt1(d));break;default:alert(d)}++lineNum;break;case"rem":++lineNum;break;case"clear":hout="",++lineNum;break;case"goto":switch(c[1]){case"abs":lineNum=+d;break;case"abs-last":lineNum=significantLines-d;break;case"rel":lineNum+=+d;break;default:lineNum=variableList["tag_"+d]}break;case"loop":e=d.match(/(\S*)\s*([\s\S]*)/);var g=variableList["tag_"+e[2]];switch(c[1]){case"inc":variableList["var_"+e[1]]++;break;case"call":return void(elseCon?lineNum++:(calls[++callsp]=lastIF,calls[++callsp]=lastIF,calls[++callsp]=!1,lineNum=variableList["tag_"+d]));default:variableList["var_"+e[1]]--}variableList["var_"+e[1]]?lineNum=g:++lineNum,variableList["var_"+e[1]]=""+variableList["var_"+e[1]];break;case"call":switch(c[1]){case"abs":calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum=+d;break;case"abs-last":calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum=significantLines-d;break;case"rel":calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum+=+d;break;case"ret":elseCon=calls[callsp--],lastIF=calls[callsp--],lineNum=calls[callsp--];break;default:calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum=variableList["tag_"+d]}break;case"break":++lineNum,breakpoint=!0,rframe=!1;break;case"terminate":breakpoint=!0,rframe=!1;break;case"nextf":++lineNum,breakpoint=!0,rframe=!0;break;case"execf":KernelStep(parseFmt1(d));break;case"set":var e=d.match(/^\s*([^=]*)\s*=([\s\S]*)$/)||[d,d,""];switch(c[1]){case"f":variableList["var_"+e[1]]=parseFmt1(e[2]);break;case"a":variableList["var_"+e[1]]=""+execNumExpr(e[2].replace(/\s/g,""));break;case"af":variableList["var_"+e[1]]=""+execNumExpr(parseFmt1(e[2]).replace(/\s/g,""));break;case"p":variableList["var_"+e[1]]=""+prompt(e[2]);break;case"pf":variableList["var_"+e[1]]=""+prompt(parseFmt1(e[2]));break;case"ln":/^\s*\d\s*$/.test(e[1])?compiled[+e[1]]=variableList["var_"+e[2]]:variableList["var_"+e[1]]=compiled[+e[2]];break;case"del":delete variableList["var_"+e[1]];break;case"push":st0[++st0p]=variableList["var_"+e[1]];break;case"pop":variableList["var_"+e[1]]=st0[st0p--];break;default:variableList["var_"+e[1]]=e[2]}++lineNum;break;case"terminate":breakpoint=!0,rframe=!1;break;case"if":e=d.match(/(\S*)\s*(\S*)\s*(\S*)\s*([\s\S]*)/);var h=cmpF(e[2],+parseFmt1(e[1]),+parseFmt1(e[3]));"not"===c[1]&&(h=!h),elseCon=!h,lastIF=lineNum,h?KernelStep(e[4]):++lineNum;break;case"if_str":e=d.match(/(\S*)\s*(\S*)\s*(\S*)\s*([\s\S]*)/);var h=cmpF(e[2],parseFmt1(e[1]),parseFmt1(e[3]));"not"===c[1]&&(h=!h),elseCon=!h,lastIF=lineNum,h?KernelStep(e[4]):++lineNum;break;case"confirm":e=d.match(/("?)(.*?)\1(?:\s+([\s\S]*))?/);var i=confirm(e[2]);"not"===c[2]&&(i=!i),elseCon=!i,lastIF=lineNum,i?KernelStep(e[3]):++lineNum;break;case"else":elseCon?(elseCon=!1,KernelStep(d)):++lineNum;break;default:alert("\u627e\u4e0d\u5230 "+c[0]+" \u6307\u4ee4"),console.error("\u627e\u4e0d\u5230 "+c[0]+" \u6307\u4ee4"),breakpoint=!0,rframe=!1}}var firstTime=new Date,elseCon=!1,lastIF,zpadd2=function(a){return 10>a?"0"+a:a},zpadd3=function(a){return 10>a?"00"+a:100>a?"0"+a:a};
