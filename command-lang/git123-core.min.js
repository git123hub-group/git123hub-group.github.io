function parseFmt1(e){var a=new Date,r=a.getFullYear()+"/"+zpadd2(a.getMonth())+"/"+zpadd2(a.getDate()),s=zpadd2(a.getHours())+":"+zpadd2(a.getMinutes())+":"+zpadd2(a.getSeconds())+"."+zpadd3(a.getMilliseconds());return e.replace(/\$((?:\\[\s\S]|[^\\\$])*)\$/g,function(e,t){if(""===t)return"$";var c,i,n=t.match(/(.*?)(?::|$)/)[1],l=t.slice(n.length+1);if("~"!==n.charAt(0))i=variableList["var_"+n];else switch(n){case"~date":i=r;break;case"~expr":return execNumExpr(l.replace(/\s/g,""));case"~time":i=s;break;case"~rtime":i=a.getTime()-firstTime.getTime()+"";break;case"~random":i=""+(4294967296*Math.random()|0);break;case"~randr":var u=l.split(",");return+u[0]+Math.random()*(u[1]-u[0]+1)|0;case"~line":return"\n";case"~space":return" ";case"~tab":return"	";case"~tline":return+significantLines+ +l}if(c=l.match(/^((?:\\[\s\S]|[^\\\=])*)=((?:\\[\s\S]|[^\\\=])*)$/)){var p=c[1].replace(/\\([\s\S])/g,"$1"),m=c[2].replace(/\\([\s\S])/g,"$1");return i.split(p).join(m)}if(c=l.match(/^(-?\d+)$/))return i.slice(c[1]);if(c=l.match(/^(-?\d+),(-?\d+)$/))return i.slice(c[1],c[2]);switch(l){case"rev":case"reverse":return esrever.reverse(i);case"len":case"length":return i.length;case"bin":return(+i>>>0).toString(2);case"chr":return String.fromCharCode(i);case"oct":return(+i>>>0).toString(8);case"hex":return(+i>>>0).toString(16);case"fbin":return parseInt(i,2);case"ord":return i.charCodeAt(0);case"foct":return parseInt(i,8);case"fhex":return parseInt(i,16);case"var":return variableList["var_"+i];case"fmt":return parseFmt1(i)}return i})}function cmpF(e,a,r){switch(e=e.toLowerCase()){case"==":case"equ":return a===r;case"!=":case"neq":return a!==r;case"<":case"lss":return r>a;case"<=":case"leq":return r>=a;case">":case"gtr":return a>r;case">=":case"geq":return a>=r}}function HTMLEscape(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function KernelStep(e){if(e=(e+"").replace(/[\s\t\xa0\u3000]*/,""),":"===e.charAt(0)||"#"===e.charAt(0)||""===e)return void++lineNum;var a=e.match(/[A-Za-z0-9\-\_$]+(:[A-Za-z0-9\-\_$]*)?/)[0],r=a.split(":");r.length<2&&(r[1]="");var s,t=e.slice(a.length).replace(/\s/,"");switch(r[0]){case"write":switch(r[1]){case"cssf":t=parseFmt1("var_"+t);case"css":hout+='<span style="'+HTMLEscape(t)+'">',KernelStep(compiled[lineNum+1]),hout+="</span>";break;case"var":hout+=HTMLEscape(variableList["var_"+t]);break;case"format":hout+=HTMLEscape(parseFmt1(t));break;case"readln":hout+=HTMLEscape(compiled[t]);break;default:hout+=HTMLEscape(t)}++lineNum;break;case"writeln":switch(r[1]){case"format":hout+=HTMLEscape(parseFmt1(t))+"\n";break;case"readln":hout+=HTMLEscape(compiled[t])+"\n";break;default:hout+=HTMLEscape(t)+"\n"}++lineNum;break;case"alert":switch(r[1]){case"format":alert(parseFmt1(t));break;default:alert(t)}++lineNum;break;case"clear":hout="",++lineNum;break;case"goto":switch(r[1]){case"abs":lineNum=+t;break;case"abs-last":lineNum=significantLines-t;break;case"rel":lineNum+=+t;break;default:lineNum=variableList["tag_"+t]}break;case"loop":s=t.match(/(\S*)\s*([\s\S]*)/);var c=variableList["tag_"+s[2]];switch(r[1]){case"inc":variableList["var_"+s[1]]++;break;case"dec":default:variableList["var_"+s[1]]--}variableList["var_"+s[1]]?lineNum=c:++lineNum,variableList["var_"+s[1]]=""+variableList["var_"+s[1]];break;case"call":switch(r[1]){case"abs":calls[callsp++]=++lineNum,lineNum=+t;break;case"abs-last":lineNum=significantLines-t;break;case"rel":calls[callsp++]=++lineNum,lineNum+=+t;break;case"ret":lineNum=calls[--callsp];break;default:calls[callsp++]=++lineNum,lineNum=variableList["tag_"+t]}break;case"break":++lineNum,breakpoint=!0,rframe=!1;break;case"nextf":++lineNum,breakpoint=!0,rframe=!0;break;case"execf":KernelStep(parseFmt1(t));break;case"set":var s=t.match(/^\s*([^=]*)\s*=([\s\S]*)$/)||[t,t,""];switch(r[1]){case"f":variableList["var_"+s[1]]=parseFmt1(s[2]);break;case"a":variableList["var_"+s[1]]=""+execNumExpr(s[2].replace(/\s/g,""));break;case"af":variableList["var_"+s[1]]=""+execNumExpr(parseFmt1(s[2]).replace(/\s/g,""));break;case"p":variableList["var_"+s[1]]=""+prompt(s[2]);break;case"pf":variableList["var_"+s[1]]=""+prompt(parseFmt1(s[2]));break;case"ln":/^\s*\d\s*$/.test(s[1])?compiled[+s[1]]=variableList["var_"+s[2]]:variableList["var_"+s[1]]=compiled[+s[2]];break;case"del":delete variableList["var_"+s[1]];break;case"push":st0[++st0p]=variableList["var_"+s[1]];break;case"pop":variableList["var_"+s[1]]=st0[st0p--];break;default:variableList["var_"+s[1]]=s[2]}++lineNum;break;case"terminate":breakpoint=!0,rframe=!1;break;case"if":s=t.match(/(\S*)\s*(\S*)\s*(\S*)\s*([\s\S]*)/);var i=cmpF(s[2],+parseFmt1(s[1]),+parseFmt1(s[3]));"not"===r[1]&&(i=!i),elseCon=!i,i?KernelStep(s[4]):++lineNum;break;case"if_str":s=t.match(/(\S*)\s*(\S*)\s*(\S*)\s*([\s\S]*)/);var i=cmpF(s[2],parseFmt1(s[1]),parseFmt1(s[3]));"not"===r[1]&&(i=!i),elseCon=!i,i?KernelStep(s[4]):++lineNum;break;case"confirm":s=t.match(/("?)(.*?)\1(?:\s+([\s\S]*))?/);var n=confirm(s[2]);"not"===r[2]&&(n=!n),elseCon=!n,n?KernelStep(s[3]):++lineNum;break;case"else":elseCon?KernelStep(t):++lineNum;break;default:alert("找不到 "+r[0]+" 指令"),console.error("找不到 "+r[0]+" 指令"),breakpoint=!0,rframe=!1}}var firstTime=new Date,elseCon,zpadd2=function(e){return 10>e?"0"+e:e},zpadd3=function(e){return 10>e?"00"+e:100>e?"0"+e:e};
