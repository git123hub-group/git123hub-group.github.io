function parseFmt1(e){var a=new Date,s=a.getFullYear()+"/"+zpadd2(a.getMonth())+"/"+zpadd2(a.getDate()),r=zpadd2(a.getHours())+":"+zpadd2(a.getMinutes())+":"+zpadd2(a.getSeconds())+"."+zpadd3(a.getMilliseconds());return e.replace(/\$((?:\\[\s\S]|[^\\\$])*)\$/g,function(e,t){if(""===t)return"$";var l,c,n,i,p=t.match(/(.*?)(?::|$)/)[1],u=t.slice(p.length+1);if("~"!==p.charAt(0))i=variableList["var_"+p];else switch(p){case"~date":i=s;break;case"~expr":return execNumExpr(u.replace(/\s/g,""));case"~time":i=r;break;case"~rtime":i=a.getTime()-firstTime.getTime()+"";break;case"~random":i=""+(4294967296*Math.random()|0);break;case"~randr":var m=u.split(",");return+m[0]+Math.random()*(m[1]-m[0]+1)|0;case"~line":return"\n";case"~space":return" ";case"~tab":return"	";case"~tline":return+significantLines+ +u}if(l=u.match(/^((?:\\[\s\S]|[^\\\=])*)=((?:\\[\s\S]|[^\\\=])*)$/))return c=l[1].replace(/\\([\s\S])/g,"$1"),n=l[2].replace(/\\([\s\S])/g,"$1"),i.split(c).join(n);if(l=u.match(/^(\w+):([\s\S]*)$/))switch(c=l[1],n=l[2].replace(/\\([\s\S])/g,"$1"),!0){case/\bfirst\b/.test(c):return i.indexOf(n);case/\blast\b/.test(c):return i.lastIndexOf(n)}if(l=u.match(/^(-?\d+)$/))return i.slice(l[1]);if(l=u.match(/^(-?\d+),(-?\d+)$/))return i.slice(l[1],l[2]);switch(u){case"rev":case"reverse":return esrever.reverse(i);case"len":case"length":return i.length;case"lower":return i.toLowerCase();case"upper":return i.toUpperCase();case"bin":return(+i>>>0).toString(2);case"chr":return String.fromCharCode(i);case"oct":return(+i>>>0).toString(8);case"hex":return(+i>>>0).toString(16);case"fbin":return parseInt(i,2);case"ord":return i.charCodeAt(0);case"foct":return parseInt(i,8);case"fhex":return parseInt(i,16);case"var":return variableList["var_"+i];case"fmt":return parseFmt1(i)}return i})}function cmpF(e,a,s){switch(e=e.toLowerCase()){case"==":case"equ":return a===s;case"!=":case"neq":return a!==s;case"<":case"lss":return s>a;case"<=":case"leq":return s>=a;case">":case"gtr":return a>s;case">=":case"geq":return a>=s}}function HTMLEscape(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function KernelStep(e){if(e=(e+"").replace(/[\s\t\xa0\u3000]*/,""),":"===e.charAt(0)||"#"===e.charAt(0)||""===e)return void++lineNum;var a,s=e.match(/[A-Za-z0-9\-\_$]+(:[A-Za-z0-9\-\_$]*)?/)[0],r=s.split(":");r.length<2&&(r[1]="");var t,l=e.slice(s.length).replace(/\s/,"");switch(r[0]){case"write":switch(r[1]){case"cssf":l=parseFmt1("var_"+l),hout+='<span style="'+HTMLEscape(l)+'">',KernelStep(compiled[lineNum+1]),hout+="</span>";break;case"css":hout+='<span style="'+HTMLEscape(l)+'">',KernelStep(compiled[lineNum+1]),hout+="</span>";break;case"multi":for(var c=parseInt(l);c&&!(lineNum+1>=significantLines);)hout+=HTMLEscape(compiled[++lineNum]),--c;break;case"var":hout+=HTMLEscape(variableList["var_"+l]);break;case"format":hout+=HTMLEscape(parseFmt1(l));break;case"readln":hout+=HTMLEscape(compiled[l]);break;default:hout+=HTMLEscape(l)}++lineNum;break;case"writeln":switch(r[1]){case"format":hout+=HTMLEscape(parseFmt1(l))+"\n";break;case"readln":hout+=HTMLEscape(compiled[l])+"\n";break;case"multi":for(var c=parseInt(l);c&&!(lineNum+1>=significantLines);)hout+=HTMLEscape(compiled[++lineNum])+"\n",--c;break;default:hout+=HTMLEscape(l)+"\n"}++lineNum;break;case"alert":switch(r[1]){case"format":alert(parseFmt1(l));break;default:alert(l)}++lineNum;break;case"rem":++lineNum;break;case"clear":hout="",++lineNum;break;case"goto":switch(r[1]){case"abs":lineNum=+l;break;case"abs-last":lineNum=significantLines-l;break;case"rel":lineNum+=+l;break;default:lineNum=variableList["tag_"+l]}break;case"loop":t=l.match(/(\S*)\s*([\s\S]*)/);var n=variableList["tag_"+t[2]];switch(r[1]){case"inc":variableList["var_"+t[1]]++;break;case"call":return void(elseCon?lineNum++:(calls[++callsp]=lastIF,calls[++callsp]=lastIF,calls[++callsp]=!1,lineNum=variableList["tag_"+l]));default:variableList["var_"+t[1]]--}variableList["var_"+t[1]]?lineNum=n:++lineNum,variableList["var_"+t[1]]=""+variableList["var_"+t[1]];break;case"call":switch(r[1]){case"abs":calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum=+l;break;case"abs-last":calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum=significantLines-l;break;case"rel":calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum+=+l;break;case"ret":elseCon=calls[callsp--],lastIF=calls[callsp--],lineNum=calls[callsp--];break;default:calls[++callsp]=++lineNum,calls[++callsp]=lastIF,calls[++callsp]=elseCon,lineNum=variableList["tag_"+l]}break;case"cflag":switch(r[1]){case"set":flag=!0;break;case"clear":flag=!1;break;case"compl":flag=~flag;break;case"push":st1[++st1p]=flag;break;case"pop":flag=st1[st1p--];break;default:t=l.split(" "),flag=cmpF(t[1],t[0],t[2])}break;case"break":++lineNum,breakpoint=!0,rframe=!1;break;case"terminate":breakpoint=!0,rframe=!1;break;case"nextf":++lineNum,breakpoint=!0,rframe=!0;break;case"execf":KernelStep(parseFmt1(l));break;case"set":var t=l.match(/^\s*([^=]*)\s*=([\s\S]*)$/)||[l,l,""];switch(r[1]){case"f":variableList["var_"+t[1]]=parseFmt1(t[2]);break;case"a":variableList["var_"+t[1]]=""+execNumExpr(t[2].replace(/\s/g,""));break;case"af":variableList["var_"+t[1]]=""+execNumExpr(parseFmt1(t[2]).replace(/\s/g,""));break;case"p":variableList["var_"+t[1]]=""+prompt(t[2]);break;case"pf":variableList["var_"+t[1]]=""+prompt(parseFmt1(t[2]));break;case"ln":/^\s*\d\s*$/.test(t[1])?compiled[+t[1]]=variableList["var_"+t[2]]:variableList["var_"+t[1]]=compiled[+t[2]];break;case"del":delete variableList["var_"+t[1]];break;case"push":st0[++st0p]=variableList["var_"+t[1]];break;case"pop":variableList["var_"+t[1]]=st0[st0p--];break;default:variableList["var_"+t[1]]=t[2]}++lineNum;break;case"terminate":breakpoint=!0,rframe=!1;break;case"if":t=l.match(/(\S*)\s*(\S*)\s*(\S*)\s*([\s\S]*)/),a=cmpF(t[2],+parseFmt1(t[1]),+parseFmt1(t[3])),"not"===r[1]&&(a=!a),elseCon=!a,lastIF=lineNum,a?KernelStep(t[4]):++lineNum;break;case"if_str":t=l.match(/(\S*)\s*(\S*)\s*(\S*)\s*([\s\S]*)/),a=cmpF(t[2],parseFmt1(t[1]),parseFmt1(t[3])),"not"===r[1]&&(a=!a),elseCon=!a,lastIF=lineNum,a?KernelStep(t[4]):++lineNum;break;case"if_flag":a="not"===r[1]?!flag:flag,elseCon=!a,lastIF=lineNum,a?KernelStep(l):++lineNum;break;case"confirm":t=l.match(/("?)(.*?)\1(?:\s+([\s\S]*))?/);var i=confirm(t[2]);"not"===r[2]&&(i=!i),elseCon=!i,lastIF=lineNum,i?KernelStep(t[3]):++lineNum;break;case"else":elseCon?(elseCon=!1,KernelStep(l)):++lineNum;break;default:alert("找不到 "+r[0]+" 指令"),console.error("找不到 "+r[0]+" 指令"),breakpoint=!0,rframe=!1}}var firstTime=new Date,elseCon=!1,lastIF,st1,st1p,flag,zpadd2=function(e){return 10>e?"0"+e:e},zpadd3=function(e){return 10>e?"00"+e:100>e?"0"+e:e};
